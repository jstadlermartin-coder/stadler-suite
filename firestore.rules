rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user email matches hotel domain
    function isHotelUser() {
      return isAuthenticated() &&
             request.auth.token.email.matches('.*@seegasthof-stadler[.]at$');
    }

    // Settings collection - hotel info, categories, seasons
    match /settings/{document} {
      allow read: if isAuthenticated();
      allow write: if isHotelUser();
    }

    // Guests collection
    match /guests/{guestId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isHotelUser();
    }

    // Bookings collection
    match /bookings/{bookingId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isHotelUser();
    }

    // Inquiries collection
    match /inquiries/{inquiryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isHotelUser();
    }

    // Offers collection
    match /offers/{offerId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if isHotelUser();
    }

    // Packages collection
    match /packages/{packageId} {
      allow read: if isAuthenticated();
      allow write: if isHotelUser();
    }

    // Sync logs collection (for bridge)
    match /syncLogs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // CapHotel sync/backup collection
    match /caphotelSync/{document} {
      allow read: if isAuthenticated();
      allow write: if isHotelUser();
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
